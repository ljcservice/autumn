<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="HaskjDrugMapper">
<!-- 处方数，含外用 -->
	<select id="haskjDrug11" parameterType="page" resultType="pd" >
		select org_name dept_name,
	       org_code dept_code,
	       c,
	       haskj,
	       haskj / c * 100 rate
		from (select org_code, org_name, count(*) c, sum(haskj) haskj
	          from presc t
	         where order_type = 1
	         	<if test="pd.beginDate != null and pd.beginDate != ''"> <!-- 更新时间 开始-->  
					and t.ORDER_DATE &gt;= #{pd.beginDate} 
				</if>
				<if test="pd.endDate != null and pd.endDate != ''"> <!-- 更新时间 结束-->
					and t.ORDER_DATE &lt; #{pd.endDate}
				</if>
				<if test="pd.org_name != null and pd.org_name != ''"> <!-- 科室-->
					and t.org_name = #{pd.org_name}
				</if>
        	group by org_code, org_name)
 		order by rate desc
	</select>
<!-- 	处方数，不含外用 -->
	<select id="haskjDrug12" parameterType="page" resultType="pd" >
		select org_name dept_name,
	       org_code dept_code,
	       c,
	       haskj,
	       haskj / c * 100 rate
  		from (select org_code,
               org_name,
               count(*) c,
               (sum(haskj) - sum(decode(haskj, 0, 0, EXTEDRUG))) haskj
          from patienthistory.presc t
         where order_type = 1
           <if test="pd.beginDate != null and pd.beginDate != ''"> <!-- 更新时间 开始-->  
					and t.ORDER_DATE &gt;= #{pd.beginDate} 
				</if>
				<if test="pd.endDate != null and pd.endDate != ''"> <!-- 更新时间 结束-->
					and t.ORDER_DATE &lt; #{pd.endDate}
				</if>
				<if test="pd.org_name != null and pd.org_name != ''"> <!-- 科室-->
					and t.org_name = #{pd.org_name}
				</if>
         group by org_code, org_name)
 		order by rate desc
	</select>
<!-- 	处方数(人次) ，含外用 -->
	<select id="haskjDrug13" parameterType="page" resultType="pd" >
		select org_code dept_code,
			org_name dept_name,
			c,
			haskj,
			haskj / c * 100 rate
  		from (select org_code,
               org_name,
               count(*) c,
               sum(decode(haskj, 0, 0, 1)) haskj
          		from (select org_code,
                       org_name,
                       patient_id,
                       order_date,
                       sum(haskj) haskj,
                       sum(decode(haskj, 0, 0, EXTEDRUG)) EXTEDRUG
                  from presc t
                 where order_type = 1
                   <if test="pd.beginDate != null and pd.beginDate != ''"> <!-- 更新时间 开始-->  
					and t.ORDER_DATE &gt;= #{pd.beginDate} 
				</if>
				<if test="pd.endDate != null and pd.endDate != ''"> <!-- 更新时间 结束-->
					and t.ORDER_DATE &lt; #{pd.endDate}
				</if>
				<if test="pd.org_name != null and pd.org_name != ''"> <!-- 科室-->
					and t.org_name = #{pd.org_name}
				</if>
                 group by org_code, org_name, patient_id, order_date
             	)
         		group by org_code, org_name
         	)
		 order by rate desc
	</select>
<!-- 处方数(人次) ，不含外用 -->
	<select id="haskjDrug14" parameterType="page" resultType="pd" >
		select org_code dept_code,
	       org_name dept_name,
	       c,
	       haskj,
	       haskj / c * 100 rate
		from (select org_code,
               org_name,
               count(*) c,
               (sum(decode(haskj, 0, 0, 1)) - sum(decode(EXTEDRUG, 0, 0, 1))) haskj
          from (select org_code,
                       org_name,
                       patient_id,
                       order_date,
                       sum(haskj) haskj,
                       sum(decode(haskj, 0, 0, EXTEDRUG)) EXTEDRUG
                  from patienthistory.presc t
                 where order_type = 1
                  <if test="pd.beginDate != null and pd.beginDate != ''"> <!-- 更新时间 开始-->  
					and t.ORDER_DATE &gt;= #{pd.beginDate} 
				</if>
				<if test="pd.endDate != null and pd.endDate != ''"> <!-- 更新时间 结束-->
					and t.ORDER_DATE &lt; #{pd.endDate}
				</if>
				<if test="pd.org_name != null and pd.org_name != ''"> <!-- 科室-->
					and t.org_name = #{pd.org_name}
				</if>
                 group by org_code, org_name, patient_id, order_date)
         group by org_code, org_name)
 		order by rate desc
		
	</select>


	
	
	<select id="haskjDrug2" parameterType="page" resultType="pd" >
		select org_name, org_code, doctor_name, c, haskj, haskj / c rate
		  from (select org_code, org_name, count(*) c, sum(haskj) haskj, doctor_name
		          from patienthistory.presc t
		         where t.order_type = 1
		           <if test="pd.beginDate != null and pd.beginDate != ''"> <!-- 更新时间 开始-->  
					and t.ORDER_DATE &gt;= #{pd.beginDate} 
				</if>
				<if test="pd.endDate != null and pd.endDate != ''"> <!-- 更新时间 结束-->
					and t.ORDER_DATE &lt; #{pd.endDate}
				</if>
				<if test="pd.org_name != null and pd.org_name != ''"> <!-- 科室-->
					and t.org_name = #{pd.org_name}
				</if>
		         group by org_code, doctor_name, org_name)
		 order by rate desc
	
	</select>
	
</mapper>